<header>

  <!-- Nav Bar -->
  <nav id="navbar" class="navbar navbar-light navbar-expand-sm {% if site.navbar_fixed %}fixed-top{% else %}sticky-top{% endif %}">
    <div class="container">

      {% comment %} Brand (link to home) {% endcomment %}
      {% if page.url != '/' %}
      <a class="navbar-brand title font-weight-lighter" href="{{ '/' | relative_url }}">
        {%- if site.title == "blank" -%}
          {%- if site.first_name -%}
            <span class="font-weight-bold">{{- site.first_name -}}&nbsp;</span>
          {%- endif -%}
          {%- if site.middle_name -%}
            {{- site.middle_name -}}&nbsp;
          {%- endif -%}
          {%- if site.last_name -%}
            {{- site.last_name -}}
          {%- endif -%}
        {%- else -%}
          {{- site.title -}}
        {%- endif -%}
      </a>
      {%- elsif site.enable_navbar_social -%}
      <div class="navbar-brand social">
        {% include social.html %}
      </div>
      {% endif %}

      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">

          {% comment %} Resolve About page title with fallback, without shadowing `page` {% endcomment %}
          {% assign about_title = "About" %}
          {%- for pg in site.pages -%}
            {%- if pg.url == '/' or pg.permalink == '/' -%}
              {%- assign about_title = pg.title | default: "About" -%}
            {%- endif -%}
          {%- endfor -%}

          <!-- About -->
          <li class="nav-item {% if page.url == '/' %}active{% endif %}">
            <a class="nav-link" href="{{ '/' | relative_url }}">{{ about_title }}
              {%- if page.url == '/' -%}<span class="sr-only">(current)</span>{%- endif -%}
            </a>
          </li>

          {% if site.blog_nav_title %}
          <!-- Blog -->
          <li class="nav-item {% if page.url contains '/blog/' %}active{% endif %}">
            <a class="nav-link" href="{{ '/blog/' | relative_url }}">{{ site.blog_nav_title }}
              {%- if page.url contains '/blog/' -%}<span class="sr-only">(current)</span>{%- endif -%}
            </a>
          </li>
          {%- endif %}

          {% comment %} Gather nav pages from site.pages and `_pages` collection, exclude home {% endcomment %}
          {%- assign nav_pages = site.pages -%}
          {%- if site.collections and site.collections.pages -%}
            {%- assign nav_pages = nav_pages | concat: site.collections.pages.docs -%}
          {%- endif -%}

          {%- assign nav_pages = nav_pages
              | where_exp: "p", "p.nav"
              | where_exp: "p", "p.autogen == nil"
              | where_exp: "p", "p.url != '/' and p.permalink != '/'"
          -%}

          {% comment %} Sort primarily by nav_order (nil -> big), secondarily by title {% endcomment %}
          {%- assign with_order = nav_pages | where_exp:"p","p.nav_order" -%}
          {%- assign no_order  = nav_pages | where_exp:"p","p.nav_order == nil" -%}
          {%- assign with_order = with_order | sort: "nav_order" -%}
          {%- assign no_order  = no_order  | sort: "title" -%}
          {%- assign sorted_pages = with_order | concat: no_order -%}

          {%- for p in sorted_pages -%}
            {%- assign is_active = (page.url == p.url) -%}
            {%- assign has_dropdown = p.dropdown -%}
            {%- if has_dropdown -%}
              {%- assign kids = p.children | default: [] -%}
              <li class="nav-item dropdown {% if is_active %}active{% endif %}">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown-{{ forloop.index }}" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  {{ p.title }}{% if is_active %} <span class="sr-only">(current)</span>{% endif %}
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown-{{ forloop.index }}">
                  {%- for child in kids -%}
                    {%- if child.title == 'divider' -%}
                      <div class="dropdown-divider"></div>
                    {%- else -%}
                      {%- assign child_href = child.url | default: child.permalink -%}
                      <a class="dropdown-item" href="{{ child_href | relative_url }}">{{ child.title }}</a>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </li>
            {%- else -%}
              <li class="nav-item {% if is_active %}active{% endif %}">
                <a class="nav-link" href="{{ p.url | default: p.permalink | relative_url }}">
                  {{ p.title }}{% if is_active %} <span class="sr-only">(current)</span>{% endif %}
                </a>
              </li>
            {%- endif -%}
          {%- endfor -%}

          {%- if site.enable_darkmode %}
          <!-- Toggle theme mode -->
          <li class="toggle-container">
            <button id="light-toggle" title="Change theme">
              <i class="fas fa-moon"></i>
              <i class="fas fa-sun"></i>
            </button>
          </li>
          {%- endif %}
        </ul>
      </div>
    </div>
  </nav>

  {% if site.enable_progressbar %}
  <!-- Scrolling Progress Bar -->
  <progress id="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
  {%- endif %}
</header>
